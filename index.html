<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Directory - UPN Share</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body {
            background: #f4f6f9;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 300px;
            background: white;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        .folder, .video-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .folder:hover, .video-item:hover {
            background: #eef2f7;
        }
        .subfolders {
            margin-left: 1rem;
            display: none;
        }
        .open .subfolders {
            display: block;
        }
        .content {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .player {
            width: 100%;
            height: 400px;
            border: none;
            margin-bottom: 1rem;
        }
        .video-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .search-container {
            margin-bottom: 1rem;
        }
        #searchInput {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 1rem;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            body {
                flex-direction: column;
            }
            .content {
                padding-top: 0;
            }
            .player {
                height: 250px;
            }
            .video-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="directory"></div>
    <div class="content">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search videos..." autocomplete="off">
        </div>
        <iframe id="player" class="player" src="" frameborder="0" allowfullscreen></iframe>
        <div id="videoList" class="video-list"></div>
        <div id="loading" class="loading">Loading...</div>
    </div>

    <script>
        const directory = document.getElementById('directory');
        const videoList = document.getElementById('videoList');
        const searchInput = document.getElementById('searchInput');
        const loading = document.getElementById('loading');
        const player = document.getElementById('player');
        let currentFolderId = null;
        let folders = [];
        let videos = [];

        async function fetchData(folderId = null) {
            loading.style.display = 'block';
            videoList.innerHTML = '';
            try {
                const url = folderId
                    ? `/.netlify/functions/get-videos?page=1&folderId=${folderId}`
                    : `/.netlify/functions/get-videos?page=1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                folders = result.data.folders || [];
                videos = result.data.videos || [];
                renderDirectory();
                renderVideos();
            } catch (error) {
                console.error('Error fetching data:', error);
                loading.textContent = 'Failed to load data.';
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderDirectory() {
            directory.innerHTML = '';
            const rootFolders = folders.filter(f => !f.parentId);
            rootFolders.forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder';
                folderDiv.textContent = folder.name + ` (${folder.videoCount})`;
                folderDiv.onclick = () => toggleFolder(folder.id);
                const subfolders = folders.filter(f => f.parentId === folder.id);
                if (subfolders.length) {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'subfolders';
                    subfolders.forEach(sub => {
                        const subFolderDiv = document.createElement('div');
                        subFolderDiv.className = 'folder';
                        subFolderDiv.textContent = sub.name + ` (${sub.videoCount})`;
                        subFolderDiv.onclick = () => fetchData(sub.id);
                        subDiv.appendChild(subFolderDiv);
                    });
                    folderDiv.appendChild(subDiv);
                }
                directory.appendChild(folderDiv);
            });
        }

        function renderVideos() {
            videoList.innerHTML = '';
            if (videos.length) {
                videos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'video-item';
                    item.innerHTML = `
                        <img src="${video.poster || 'https://via.placeholder.com/200x120'}" alt="${video.name}" style="width: 100%; height: auto;">
                        <p>${video.name}</p>
                    `;
                    item.onclick = () => player.src = `https://purn.upn.one/#${video.id}`;
                    videoList.appendChild(item);
                });
                player.src = `https://purn.upn.one/#${videos[0].id}`; // Default to first video
            }
        }

        function toggleFolder(id) {
            const folder = directory.querySelector(`[onclick="toggleFolder('${id}')"]`);
            folder.classList.toggle('open');
            if (currentFolderId !== id) {
                fetchData(id);
                currentFolderId = id;
            }
        }

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            const filtered = videos.filter(v => v.name.toLowerCase().includes(query));
            renderVideos(filtered);
            if (filtered.length) {
                player.src = `https://purn.upn.one/#${filtered[0].id}`;
            } else {
                player.src = '';
            }
        });

        function renderVideos(filteredVideos = videos) {
            videoList.innerHTML = '';
            if (filteredVideos.length) {
                filteredVideos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'video-item';
                    item.innerHTML = `
                        <img src="${video.poster || 'https://via.placeholder.com/200x120'}" alt="${video.name}" style="width: 100%; height: auto;">
                        <p>${video.name}</p>
                    `;
                    item.onclick = () => player.src = `https://purn.upn.one/#${video.id}`;
                    videoList.appendChild(item);
                });
                player.src = `https://purn.upn.one/#${filteredVideos[0].id}`;
            }
        }

        window.addEventListener('load', () => fetchData());
    </script>
</body>
</html>