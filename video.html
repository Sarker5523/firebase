<script>
  const searchInput = document.getElementById('search-input');
  const searchResultsContainer = document.getElementById('search-suggestions');
  const iframeContainer = document.getElementById('iframe-container');
  const episodeList = document.getElementById('episode-list');

  function loadVideo(video) {
    if (!video) {
      document.getElementById('video-title').innerText = "Video not found";
      return;
    }

    document.getElementById('video-title').innerText = `${video.name} - ${video.episode_name}`;

    // Dynamically set the webpage title to the episode's title
    document.title = `${video.name} - ${video.episode_name}`;

    if (video.embed_code) {
      iframeContainer.innerHTML = video.embed_code;
      iframeContainer.style.display = 'block';
    } else {
      iframeContainer.style.display = 'none';
    }

    // Highlight the current episode button
    const buttons = episodeList.getElementsByTagName('button');
    for (let button of buttons) {
      if (button.dataset.episodeId === video.episode_id) {
        button.classList.add('active');
      } else {
        button.classList.remove('active');
      }
    }
  }

  function loadEpisodes(episodes, currentEpisodeId) {
    episodeList.innerHTML = '';
    episodes.forEach(episode => {
      const button = document.createElement('button');
      button.innerText = episode.episode_name;
      button.dataset.episodeId = episode.episode_id;
      button.onclick = () => {
        loadVideo(episode);
      };
      if (episode.episode_id === currentEpisodeId) {
        button.classList.add('active');
      }
      episodeList.appendChild(button);
    });
  }

  function parseCSV(text) {
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    const headers = lines.shift().split(',').map(header => header.trim());
    const result = [];

    lines.forEach(line => {
      const currentline = line.split(',').map(value => value.trim());
      if (currentline.length === headers.length) {
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = currentline[index];
        });
        result.push(obj);
      }
    });

    return result;
  }

  fetch('https://raw.githubusercontent.com/Sarker5523/My-Playlists/main/tv_series.csv')
    .then(response => response.text())
    .then(text => {
      const data = parseCSV(text);
      const videoId = new URLSearchParams(window.location.search).get('id');
      const series = data.find(v => v.id === videoId);
      if (series) {
        const currentEpisode = series;
        loadVideo(currentEpisode);
        const episodes = data.filter(v => v.id === series.id);
        loadEpisodes(episodes, currentEpisode.episode_id);
      } else {
        document.getElementById('video-title').innerText = "Video not found";
      }
    })
    .catch(error => {
      console.error('Error loading video data:', error);
      document.getElementById('video-title').innerText = "Error loading video";
    });

  function handleSearch() {
    const query = searchInput.value.toLowerCase();
    fetch('https://raw.githubusercontent.com/Sarker5523/My-Playlists/main/tv_series.csv')
      .then(response => response.text())
      .then(text => {
        const data = parseCSV(text);
        const filteredVideos = data.filter(video => video.name.toLowerCase().includes(query));
        const uniqueVideos = Array.from(new Set(filteredVideos.map(video => video.id)))
                                  .map(id => filteredVideos.find(video => video.id === id));

        searchResultsContainer.style.display = 'block';
        searchResultsContainer.innerHTML = '';
        uniqueVideos.slice(0, 5).forEach(video => {
          const suggestionItem = document.createElement('div');
          suggestionItem.innerHTML = `
            <img src="${video.thumbnail}" alt="${video.name}">
            ${video.name}
          `;
          suggestionItem.onclick = () => {
            window.location.href = `search-results.html?q=${encodeURIComponent(query)}`;
          };
          searchResultsContainer.appendChild(suggestionItem);
        });
      });
  }

  function handleEnter(event) {
    if (event.key === "Enter") {
      window.location.href = `search-results.html?q=${encodeURIComponent(searchInput.value)}`;
    }
  }
</script>